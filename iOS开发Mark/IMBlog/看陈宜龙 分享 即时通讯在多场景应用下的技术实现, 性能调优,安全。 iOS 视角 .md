# 看陈宜龙 分享 即时通讯在多场景应用下的技术实现, 性能调优,安全。 iOS 视角 

参考资料: [陈宜龙 IM](https://github.com/ChenYilong/iOSBlog/issues/6)
[陈宜龙 谈 IM 直播](http://m.quzhiboapp.com/?#!/live/25)
[iOS即时通讯，从入门到“放弃”？](https://www.jianshu.com/p/2dbb360886a8)

最近一直在看 IM 即时通讯的相关资料, 由于之前没有真正接触到这一块的开发, 最多都是直接外接三方 IM 框架, 然后修改一下 UI 代码.  涉及到的底层通讯 技术特别少.  现在需要自己来进行一个移动端的 IM 框架搭建, 有点无从下手的感觉。  

看完 陈宜龙的 Blog + 视频之后受益匪浅, 为了巩固上面说的知识点, 自己也做一个知识梳理和总结。

## 通讯协议选择

通讯协议选择可以说是首先需要去重点需要考虑的. 通讯协议会涉及到 **传输层** **会话层**,  传输层当前来说基本 就是两种选择 TCP/UDP。  可靠的传输协议与不可靠的传输协议, 也由于这个特性 使得两种传输协议在 传输速率, 传输稳定, 适用场景上有明显的差别.    在选择这两种传输协议上, 我们可以结合实际应用场景去进行选择。

### 通讯协议发展过程

最初的网络连接, 都是按 OSI 模型, 从 链路层 -> 网络层 -> 传输层 -> 回话层 -> 表示层 -> 应用层 -》 媒体层  这是最基础的 7 层概念.
由于 TCP 是一个面向有连接, 可靠的. 每次在 移动端与客户端建立连接时必须都要经过 3 次握手, 在到断开后 4次挥手.  想象一下假如我们频繁得需要与服务器连接,请求. 每次都要经过这个繁琐重复的流程.  在传输速度, 性能 方面是不能接受的. 更不要说在面对 IM 即时通讯下保持 消息及时性的实现 远远是不可能的。
为了实现这种能快速使 客户端与服务器 建立连接, 程序员们不断的完善以及推出新的协议来加快网络通讯的发展.  

### 当前大家都在用什么通讯协议

作者做了一份问卷调查:
1. 	[《你项目中使用什么协议实现了 IM 即时通讯》](http://vote.weibo.com/poll/137494424)

根据其调查结果也大概了解到当前市场上, 大家更倾向于使用什么 技术,以及其优缺点等等. 
IM 协议选择原则一般是：易于拓展，方便覆盖各种业务逻辑，同时又比较节约流量。后一点的需求在移动端 IM 上尤其重要。常见的协议有：XMPP、SIP、MQTT、私有协议。
一个好的协议需要满足如下条件:高效，简洁，可读性好，节约流量，易于拓展，同时又能够匹配当前团队的技术堆栈。基于如上原则，我们可以得出: 如果团队小，团队技术在 IM 上积累不够可以考虑使用 XMPP 或者 MQTT+HTTP 短连接的实现。反之可以考虑自己设计和实现私有协议，这里建议团队有计划地迁移到私有协议上。
这里特别提一下排名第二的 WebSocket ，区别于上面的聊天协议，这是一个传输通讯协议，那为什么会有这么多人在即时通讯领域运用了这一协议？除了上文说的长连接特性外，这个协议 web 原生支持，有很多第三方语言实现，可以搭配 XMPP、MQTT 等多种聊天协议进行使用，被广泛地应用于即时通讯领。


####HTTP

HTTP1.0 是建立在 TCP 之上的, 其被推出时是一种 短连接的机制. 在连接速度根本不能满足需求, 每次客户端向服务器发送请求都要走  3 次握手.
HTTP1.1 其采用了一种 长连接的机制, 来提升了每次建立连接需要消耗的 时间 和 流量. 其发送完一次请求之后 并不会直接断开, 可以继续在发送多次请求 而不需要重新 3 次 握手,  不过每次在发送请求的时候 都必须带上 **requestHeader** 服务器也是每次都会返回 **responeHeader**,  这其实也是一种流量的浪费。
HTTP/2 : 是最新研发出来的一种HTTP 协议, 对 IPv6 支持,

#### IM

为了实现客户端与服务器之间交互更加敏捷, 实时, 节省性能.

* 轮询机制: 最先出的是 短轮询机制 然后为了性能考虑,发展成了 长轮询机制。  其原理大概是这样的, 短轮询 客户端频繁得定时的发送请求到服务器, 服务器收到后进行相应。 
长轮询: 耐心的一问一答, 当客户端发送请求到服务器之后, 服务器根据查询当前状态, 如果在请求之前并无任何改变的话, 会一直等待, 直到发生改变之后才会回应给客户端。

* 长链接: 也就是上面说的 通过  TCP 传输然后设置 HTTP 协议来完成长连接,  但是使用 HTTP 来进行的长链接, 缺点也很大,  消耗流量, 传输速率不够即时, 无法完成双向传输.  [](What are Long-Polling, Websockets, Server-Sent Events (SSE) and Comet?)  所以后面为了实现这种能双向传输, 推出了 WebSocket 协议来替代 HTTP 长连接。 
* webSocket: 其诞生是从 HTML5 出来的, 当时在开发 前端的人, 为了解决 双向通讯以及信息实时性, 开发出这套协议 来与 服务器进行交互.  后面又延伸 到 移动端使用. 分别有 Socket WebSoket 都可以完成双向通讯的功能。
出于兼容性考虑，一般建立 WebSocket 连接也采用 HTTP 请求的方式，那么从这个角度讲：无论请求如何频繁，都只需要一个 Header。

![轮询- WebSocket](https://camo.githubusercontent.com/7ef55dc631677894e833768a163720ca04ad4d77/687474703a2f2f7777312e73696e61696d672e636e2f6c617267652f37383533303834636a7731663831666362747171716a3230647a306130337a322e6a7067)

数据参考：
	1.[	HTML5 WebSocket: A Quantum Leap in Scalability for the Web](https://www.websocket.org/quantum.html)
	2.	[《微信,QQ这类IM app怎么做——谈谈Websocket》](http://www.jianshu.com/p/bcefda55bce4)

## 传输协议选择

问卷调查:	[《IM 即时通讯中你会选用什么数据传输格式？》](http://vote.weibo.com/poll/137505291)

ProtocolBuffer 与 Json. 使用率相对高一点.  易于扩展,使用学习,高性能。
序列化与反序列化复杂时间都相对很低. 
XMPP 用的也挺多 但是由于 XML 的冗余,导致其性能上实在太差. 

## UI 层面实现

技术实现细节的部分较长，单独成篇。： [《技术实现细节》](https://github.com/ChenYilong/iOSBlog/blob/master/Tips/%E5%9F%BA%E4%BA%8EWebsocket%E7%9A%84IM%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E6%8A%80%E6%9C%AF/%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82.md)


## 网络层性能调优

主要针对这几个点来进行优化:

* 首选 ProtocolBuffer. 使用极简协议
* 	在安全上做了哪些事情？ 1. 防止 DNS 污染 2. 账户安全
*  重连机制的优化。
*  使用 HTTP/2 减少不必要的网络连接
*  设置合理的超时时间
* 	图片视频等文件上传优化
*  用缓存：基于 Hash 的本地缓存校验
*  
## 应对不同场景解决方案

### 社交场景
### 直播场景
### 数据自动更新场景
### 电梯场景（假在线状态处理）

## 应用安全防范

在安全上需要做哪些事情？

防止 DNS 污染
文章较长，单独成篇
[《防 DNS 污染方案.md》](https://github.com/ChenYilong/iOSBlog/blob/master/Tips/%E5%9F%BA%E4%BA%8EWebsocket%E7%9A%84IM%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E6%8A%80%E6%9C%AF/%E9%98%B2%20DNS%20%E6%B1%A1%E6%9F%93%E6%96%B9%E6%A1%88.md)

保障账户安全. [《实时通信服务总览-权限和认证》](https://leancloud.cn/docs/realtime_v2.html#%E6%9D%83%E9%99%90%E5%92%8C%E8%AE%A4%E8%AF%81)

使用单点登录


