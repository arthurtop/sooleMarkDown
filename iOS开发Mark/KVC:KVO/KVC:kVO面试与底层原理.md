# iOSä¸€é“å¤åˆå‹é¢è¯•é¢˜ä¸åº•å±‚åŸç†

## 0. å¼•è¨€

æˆ‘ä»¬å¸¸å¸¸åæ§½é¢è¯•çš„éš¾åº¦ï¼Œç”šè‡³å‡ºç°äº† **â€œé¢è¯•é€ ç«ç®­ï¼Œå¼€å‘æ‹§èºä¸â€** è¯´æ³•ã€‚ä½œä¸ºå®¢æˆ·ç«¯å¼€å‘äººå‘˜ï¼Œé¢è¯•ç›´æ¥è®©ä½ ç°åœºæ‰‹æ’¸ä¸€ä¸ªçº¢é»‘æ ‘ï¼Œéš¾åº¦æ˜¯å¾ˆå¤§çš„ï¼Œé™¤éä½ ä¸“é—¨å‡†å¤‡è¿‡ã€‚

ä½†å¸¸è§çš„è€ƒç‚¹æˆ‘ä»¬æ˜¯éœ€è¦çŸ¥é“çš„ã€‚æœ‰æ—¶è€ƒç‚¹å¯èƒ½è¢«åŒ…è£…äº†ä¸€ä¸‹ï¼Œå¯èƒ½æ²¡æ³•ä¸€ä¸‹å°±çœ‹å‡ºæ¥ï¼Œä½†çœ‹ç ´è€ƒç‚¹ä¹‹åå°±ä¼šæœ‰æç„¶å¤§æ‚Ÿçš„æ„Ÿè§‰ã€‚å› ä¸ºæœ¬è´¨è¿˜æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯æ–°ç“¶è£…æ—§é…’ã€‚å°±åƒåŸæ¥çš„ç†ç§‘è€ƒè¯•é¢˜ï¼ŒåŒ…è£…ä¸€ä¸ªæ–°çš„åœºæ™¯ï¼Œè®©ä½ è§£å†³è¿™ä¸ªåœºæ™¯ä¸‹çš„ä¸€ä¸ªé—®é¢˜ï¼Œä½†ç†è®ºçŸ¥è¯†éƒ½æ˜¯å­¦è¿‡çš„ã€‚

å¥½äº†ï¼Œä¸‹é¢åºŸè¯ä¸å¤šè¯´ï¼Œè¿›å…¥æˆ‘ä»¬çš„é—®é¢˜ã€‚

## 1. é¢è¯•é¢˜

### 1.1 é¢˜ç›®

æˆ‘ä»¬ä»çƒ­èº«å¼€å§‹ï¼Œæ…¢æ…¢æ·±å…¥ï¼š

- é¢è¯•é¢˜1

  ç°æœ‰ä¸€ä¸ªç»§æ‰¿äºNSObjectçš„å®ä¾‹å¯¹è±¡ï¼Œéœ€è¦åœ¨ä¸ç›´æ¥ä¿®æ”¹æ–¹æ³•å®ç°çš„æƒ…å†µä¸‹ï¼Œæ”¹å˜ä¸€ä¸ªæ–¹æ³•çš„è¡Œä¸ºï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿ

  > ä¸ç›´æ¥ä¿®æ”¹æ–¹æ³•å®ç°ï¼ŒæŒ‡çš„æ˜¯ä¸ç›´æ¥ä¿®æ”¹.mæ–‡ä»¶ä¸­æ–¹æ³•çš„å†…éƒ¨å®ç°

  è¿™ä¸€é“é¢˜æ¯”è¾ƒç®€å•ï¼Œå…¶å®é—®çš„å°±æ˜¯ **Runtime** çš„ **Method Swizzling** ã€‚å¯èƒ½ç­”å‡ºæ¥ä¹‹åï¼Œè¿˜ä¼šé—®å‡ ä¸ª **Method Swizzling** ç›¸å…³çš„æ·±å…¥é—®é¢˜ã€‚ä¸‹é¢éš¾åº¦å‡çº§ã€‚

- é¢è¯•é¢˜2

  é—®é¢˜1ï¼Œå¦‚æœä½¿ç”¨ **Method Swizzling** æŠ€æœ¯ï¼Œç›¸å½“äºä¿®æ”¹äº†ç±»å¯¹è±¡ä¸­æ–¹æ³•é€‰æ‹©å™¨å’ŒIMPå®ç°çš„å¯¹åº”å…³ç³»ã€‚è¿™å°†å¯¼è‡´ç»§æ‰¿è‡ªè¿™ä¸ªç±»çš„æ‰€æœ‰å­ç±»å’Œå®ä¾‹å¯¹è±¡éƒ½å½±å“ï¼Œå¦‚ä½•æ§åˆ¶å—å½±å“çš„èŒƒå›´ï¼Œæˆ–è€…è¯´å¦‚ä½•è®©æ–¹æ³•çš„è¡Œä¸ºæ”¹å˜åªå¯¹è¿™ä¸ªå®ä¾‹å¯¹è±¡ç”Ÿæ•ˆï¼Ÿ

  è¿™ä¸ªé¢˜éš¾åº¦ä¸Šå‡äº†ï¼Œä½†æ˜¯ä¸æ˜¯æœ‰ä¸€ç§è„±ç¦»ç”Ÿäº§çš„æ„Ÿè§‰ï¼Œä¸ºäº†é¢è¯•ä½ è€Œå‡ºçš„ä¸€é“é¢˜ï¼Ÿ

  æˆ‘ä»¬å¯¹è¿™ä¸ªé—®é¢˜åŒ…è£…ä¸€ä¸‹ï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´æ¥åœ°æ°”ï¼ŒåŒæ—¶é—®é¢˜ä¹Ÿå†å‡çº§ä¸€ç‚¹ã€‚

- é¢è¯•é¢˜3

  ç°æœ‰ä¸€ä¸ªè§†å›¾ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å¤§ä¸€ä¸‹å®ƒçš„å“åº”èŒƒå›´ã€‚å¦‚æœä½¿ç”¨ **Method Swizzling** æŠ€æœ¯ï¼Œå—å½±å“çš„èŒƒå›´ä¼šæ¯”è¾ƒå¤§ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ç»§æ‰¿ä¸€ä¸ªå­ç±»æ¥å®ç°ã€‚ä½†å¦‚æœç°åœ¨å®ä¾‹å·²ç»åˆ›å»ºäº†ï¼Œè¿˜æ˜¯åŒæ ·çš„éœ€æ±‚ï¼Œä½ ä¼šå¦‚ä½•å®ç°ï¼Ÿ

  ç°åœ¨é—®é¢˜å¼€å§‹æ¥è¿‘ç”Ÿäº§äº†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¿®æ”¹å“åº”èŒƒå›´æ¶‰åŠåˆ° **å“åº”é“¾å’Œäº‹ä»¶ä¼ é€’** çš„çŸ¥è¯†ç‚¹ã€‚

  - å¦‚æœå¯ä»¥ç»§æ‰¿ï¼Œå½“ç„¶å¯ä»¥é€‰æ‹©å¤å†™ä¸¤ä¸ªæ–¹æ³•æ¥è§£å†³ã€‚
    - **- hitTest:withEvent:**
    - **- pointInside:withEvent:**

  ç°åœ¨é™åˆ¶äº†**ç»§æ‰¿å¹¶åˆ›å»ºå­ç±»å®ä¾‹** çš„æ–¹æ¡ˆï¼Œåªèƒ½é€‰æ‹©å…¶ä»–åŠæ³•ã€‚

  - å¦‚æœå›ç­” **Method Swizzling** æŠ€æœ¯ï¼Œåˆæ¶‰åŠåˆ°å½±å“èŒƒå›´é—®é¢˜ï¼Œå¯èƒ½éœ€è¦åŠ å¼€å…³ã€åŠ æ‰©å¤§å“åº”èŒƒå›´è®°å½•çš„å˜é‡ç­‰ï¼Œåˆ™åˆæ¶‰åŠåˆ° **å…³è”å¯¹è±¡** ç›¸å…³çš„é—®é¢˜ã€‚

  ç°åœ¨åŒæ ·ä¹Ÿé™åˆ¶äº† **Method Swizzling** æ–¹æ¡ˆï¼Œè¿˜æœ‰ä»€ä¹ˆåŠæ³•å‘¢ï¼Ÿ

  ç­”æ¡ˆè¿˜æ˜¯ **Runtime** æŠ€æœ¯ã€‚ä½†è¿™ä¸ªä¼šæ¶‰åŠåˆ°2ä¸ª **Runtime** è€ƒç‚¹ï¼š**æ¶ˆæ¯å‘é€ä¸è½¬å‘** ä»¥åŠ **isa-swizzling** ã€‚

  - **æ¶ˆæ¯å‘é€ä¸è½¬å‘**ï¼šä¸»è¦æ˜¯ **objc_msgSend** ä¹‹åçš„æ–¹æ³•æŸ¥æ‰¾æµç¨‹ã€‚å¦‚æœç»§ç»­æ·±å…¥é—®ï¼Œä¼šåˆ° **æ¶ˆæ¯è½¬å‘** ç›¸å…³çš„è€ƒç‚¹ã€‚
  - **isa-swizzling** ï¼šå¸¸è§äº **KVO** åŸç†è€ƒç‚¹ï¼Œä½†å…¶å®è¯´åˆ° **isa-swizzling** è‚¯å®šä¼šä¼´éšç€ **æ¶ˆæ¯å‘é€ä¸è½¬å‘** é—®é¢˜ã€‚å› ä¸ºä¿®æ”¹äº†`isa`çš„æŒ‡å‘ï¼Œæ‰§è¡Œ **objc_msgSend** æ—¶çš„æŸ¥æ‰¾æµç¨‹ä¼šå‘ç”Ÿå˜åŒ–ã€‚

å…¶å®ï¼Œä»ç¬¬1é—®åˆ°ç¬¬3é—®ï¼Œé—®çš„æ ¸å¿ƒéƒ½æ˜¯ **isa-swizzling** ï¼Œä½†é€šè¿‡å±‚å±‚åŒ…è£…å¯èƒ½æ¶‰åŠåˆ° **å¤šä¸ªçŸ¥è¯†ç‚¹**ï¼Œå˜æˆä¸€é“å¤åˆå‹é¢è¯•é¢˜ã€‚

### 1.2 ç¤ºä¾‹

æˆ‘ä»¬æ¥å†™ä¸€ä¸ªä¾‹å­ï¼š

```
@interface Person : NSObject
@property (nonatomic, strong, nullable) NSString *firstName;
@property (nonatomic, strong, nullable) NSString *lastName;
@end

@implementation Person
@end

@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];
    
    Person *person = [[Person alloc] init];
    person.firstName = @"Tom";
    person.lastName = @"Google";
    
    NSLog(@"person full name: %@ %@", person.firstName, person.lastName);
}
@end
å¤åˆ¶ä»£ç 
```

ç°åœ¨è¦åœ¨åˆ›å»ºäº†`person`å®ä¾‹åï¼Œä¿®æ”¹`lastName`çš„è¿”å›å€¼ï¼Œå°†å…¶å›ºå®šè¿”å› **Apple** ã€‚

```
@interface Person : NSObject
@property (nonatomic, strong, nullable) NSString *firstName;
@property (nonatomic, strong, nullable) NSString *lastName;
@end

@implementation Person
@end

NSString *demo_getLastName(id self, SEL selector)
{
    return @"Apple";
}

@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];
    
    Person *person = [[Person alloc] init];
    person.firstName = @"Tom";
    person.lastName = @"Google";
    
    NSLog(@"person full name: %@ %@", person.firstName, person.lastName);
    
    // 1.åˆ›å»ºä¸€ä¸ªå­ç±»
    NSString *oldName = NSStringFromClass([person class]);
    NSString *newName = [NSString stringWithFormat:@"Subclass_%@", oldName];
    Class customClass = objc_allocateClassPair([person class], newName.UTF8String, 0);
    objc_registerClassPair(customClass);
    // 2.é‡å†™getæ–¹æ³•
    SEL sel = @selector(lastName);
    Method method = class_getInstanceMethod([person class], sel);
    const char *type = method_getTypeEncoding(method);
    class_addMethod(customClass, sel, (IMP)demo_getLastName, type);
    // 3.ä¿®æ”¹ä¿®æ”¹isaæŒ‡é’ˆ(isa swizzling)
    object_setClass(person, customClass);
    
    NSLog(@"person full name: %@ %@", person.firstName, person.lastName);
    
    Person *person2 = [[Person alloc] init];
    person2.firstName = @"Jerry";
    person2.lastName = @"Google";
    NSLog(@"person2 full name: %@ %@", person2.firstName, person2.lastName);
}
@end
// è¾“å‡º
person full name: Tom Google
person full name: Tom Apple
person2 full name: Jerry Google
å¤åˆ¶ä»£ç 
```

ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä½¿ç”¨ **isa-swizzling** å°†`person`å¯¹è±¡`lastName`çš„è¡Œä¸ºæ”¹å˜äº†ï¼Œè€Œ`person2`å¯¹è±¡æ²¡æœ‰å—åˆ°å½±å“ã€‚

æˆ‘ä»¬ä¸€èˆ¬çŸ¥é“ **isa-swizzling** æ˜¯ **KVO** çš„åº•å±‚åŸç†ï¼Œä½†ä¸èƒ½åªçŸ¥é“æ‹¿æ¥åš **KVO** ã€‚

æˆ‘æƒ³é€šè¿‡è¿™ä¸ªé¢è¯•é¢˜ï¼Œä»‹ç»ä¸€ç§å¦‚ä½•åœ¨æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨ **isa-swizzling** çš„æ€è·¯ã€‚

ä¸‹é¢æ˜¯ **KVO** åŸç†ï¼Œå¦‚æœä½ éå¸¸è‡ªä¿¡å·²ç»ç†Ÿæ‚‰è¿™éƒ¨åˆ†å†…å®¹ï¼Œå¯ä»¥ä¸çœ‹äº†~

**å¦‚æœè§‰å¾—è¿™ä¸ªé¢è¯•é¢˜å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œç»™æˆ‘ç‚¹ä¸ªèµå§~** ğŸ‘ğŸ»

![img](https://user-gold-cdn.xitu.io/2020/4/30/171ca690426b6532?imageView2/0/w/1280/h/960/ignore-error/1)

## 2. ç”±æµ…å…¥æ·±æ¢ç´¢KVO

æˆ‘ä»¬å†å›åˆ°åº”ç”¨è¿™ä¸ªåŸç†çš„ **KVO** ä¸Šã€‚

### 2.1 KVOåº”ç”¨

ç»™å¤§å®¶å†å‡ºä¸€é“ç®€å•çš„å…³äºKVOæ—¥å¸¸åº”ç”¨çš„é¢˜ã€‚

```
@interface Person : NSObject
@property (nonatomic, strong, nullable) NSString *firstName;
@property (nonatomic, strong, nullable) NSString *lastName;
@property (nonatomic, strong, readonly) NSString *fullName;
@end

@implementation Person
- (NSString *)fullName {
    return [NSString stringWithFormat:@"%@ %@", self.firstName, self.lastName];
}
@end
å¤åˆ¶ä»£ç 
```

å¦‚ä½•åœ¨ä¿®æ”¹`firstName`æˆ–`lastName`æ—¶ï¼Œæ‰§è¡Œé€šçŸ¥`fullName`å˜åŒ–äº†ã€‚å¦‚æœä½ çš„æ€è·¯æ˜¯ï¼Œåœ¨`firstName`æˆ–`lastName`çš„setæ–¹æ³•ä¸­æ‰‹åŠ¨è°ƒç”¨ **willChangeValueForKey:** å’Œ **didChangeValueForKey:** ï¼Œé‚£ä¹ˆå¼ºçƒˆå»ºè®®é˜…è¯»æ­¤éƒ¨åˆ†ã€‚

#### 2.1.1 è‡ªåŠ¨é€šçŸ¥

```
// è°ƒç”¨setæ–¹æ³•
[account setName:@"Savings"];

// ä½¿ç”¨KVC forKeyæˆ–forKeyPath
[account setValue:@"Savings" forKey:@"name"];
[document setValue:@"Savings" forKeyPath:@"account.name"];

// ä½¿ç”¨ mutableArrayValueForKey: æ£€ç´¢å…³ç³»ä»£ç†å¯¹è±¡
Transaction *newTransaction = <#Create a new transaction for the account#>;
NSMutableArray *transactions = [account mutableArrayValueForKey:@"transactions"];
[transactions addObject:newTransaction];
å¤åˆ¶ä»£ç 
```

**ç¤ºä¾‹**

```
@interface ViewController ()
@property (nonatomic, strong) Person *person;
@property (nonatomic, strong) NSMutableArray<Person *> *people;
@end

@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];
    // éé›†åˆ
    self.person = [[Person alloc] init];
    [self.person addObserver:self forKeyPath:@"name" options:NSKeyValueObservingOptionNew context:nil];
    self.person.name = @"Tom";
    [self.person setValue:@"Jerry" forKey:@"name"];
    [self setValue:@"Tom" forKeyPath:@"person.name"];
    // é›†åˆ
    self.people = [NSMutableArray array];
    Person *person0 = [[Person alloc] init];
    person0.name = @"Tom";
    [self.people addObject:person0];
    Person *person1 = [[Person alloc] init];
    person1.name = @"Jerry";
    [self.people addObject:person1];
    NSString *key = @"people";
    [self addObserver:self forKeyPath:key options:NSKeyValueObservingOptionNew context:nil];
    Person *person2 = [[Person alloc] init];
    person2.name = @"Frank";
    NSMutableArray *people = [self mutableArrayValueForKey:key];
    [people addObject:person2];
    NSLog(@"People: \n%@", self.people);
}

- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary *)change context:(void *)context {
    if ([keyPath isEqualToString:@"name"]) {
        NSLog(@"new name: %@", change[NSKeyValueChangeNewKey]);
    } else if ([keyPath isEqualToString:@"people"]) {
        NSLog(@"new array: %@", change[NSKeyValueChangeNewKey]);
        NSArray<Person *> *people = change[NSKeyValueChangeNewKey];
        NSLog(@"new person: %@", people.firstObject.name);
    }
}
@end
// è¾“å‡º
new name: Tom
new name: Jerry
new name: Tom
new array: (
    "<Person: 0x60000276cc20>"
)
new person: Frank
People: 
(
    "Person name: Tom",
    "Person name: Jerry",
    "Person name: Frank"
)
å¤åˆ¶ä»£ç 
```

#### 2.1.2 æ‰‹åŠ¨é€šçŸ¥

æ‰‹åŠ¨é€šçŸ¥æä¾›äº†æ›´è‡ªç”±çš„æ–¹å¼å»å†³å®šä»€ä¹ˆæ—¶é—´ï¼Œä»€ä¹ˆæ–¹å¼å»é€šçŸ¥è§‚å¯Ÿè€…ã€‚æƒ³è¦ä½¿ç”¨æ‰‹åŠ¨é€šçŸ¥å¿…é¡»å®ç° **automaticallyNotifiesObserversForKey:** (æˆ–è€… **automaticallyNotifiesObserversOf<Key>** )æ–¹æ³•ã€‚åœ¨ä¸€ä¸ªç±»ä¸­åŒæ—¶ä½¿ç”¨è‡ªåŠ¨å’Œæ‰‹åŠ¨é€šçŸ¥æ˜¯å¯è¡Œçš„ã€‚å¯¹äºæƒ³è¦æ‰‹åŠ¨é€šçŸ¥çš„å±æ€§ï¼Œå¯ä»¥æ ¹æ®å®ƒçš„keyPathè¿”å›NOï¼Œè€Œå…¶å¯¹äºå…¶ä»–ä½ç½®çš„keyPathï¼Œè¦è¿”å›çˆ¶ç±»çš„è¿™ä¸ªæ–¹æ³•ã€‚

```
+ (BOOL)automaticallyNotifiesObserversForKey:(NSString *)key {
    if ([key isEqualToString:@"name"]) {
        return NO;
    } else {
        return [super automaticallyNotifiesObserversForKey:key];
    }
}
// æˆ–è€…
+ (BOOL)automaticallyNotifiesObserversOfName {
    return NO;
}
å¤åˆ¶ä»£ç 
```

##### ä¸€å¯¹ä¸€å…³ç³»

```
- (void)setOpeningBalance:(double)theBalance {
     if (theBalance != _openingBalance) {
        [self willChangeValueForKey:@"openingBalance"];
        _openingBalance = theBalance;
        [self didChangeValueForKey:@"openingBalance"];
     }
}
å¤åˆ¶ä»£ç 
```

å¦‚æœä¸€ä¸ªæ“ä½œä¼šå¯¼è‡´å¤šä¸ªå±æ€§æ”¹å˜ï¼Œéœ€è¦åµŒå¥—é€šçŸ¥ï¼š

```
- (void)setOpeningBalance:(double)theBalance {
     [self willChangeValueForKey:@"openingBalance"];
     [self willChangeValueForKey:@"itemChanged"];
     _openingBalance = theBalance;
     _itemChanged = _itemChanged + 1;
     [self didChangeValueForKey:@"itemChanged"];
     [self didChangeValueForKey:@"openingBalance"];
}
å¤åˆ¶ä»£ç 
```

##### ä¸€å¯¹å¤šçš„å…³ç³»

å¿…é¡»æ³¨æ„ä¸ä»…ä»…æ˜¯è¿™ä¸ªkeyæ”¹å˜äº†ï¼Œè¿˜æœ‰å®ƒæ”¹å˜çš„ç±»å‹ä»¥åŠç´¢å¼•ã€‚

```
- (void)removeTransactionsAtIndexes:(NSIndexSet *)indexes {
     [self willChange:NSKeyValueChangeRemoval valuesAtIndexes:indexes forKey:@"transactions"];
     // Remove the transaction objects at the specified indexes.
     [self didChange:NSKeyValueChangeRemoval valuesAtIndexes:indexes forKey:@"transactions"];
}
å¤åˆ¶ä»£ç 
```

#### 2.1.3 é”®ä¹‹é—´çš„ä¾èµ–

åœ¨å¾ˆå¤šç§æƒ…å†µä¸‹ä¸€ä¸ªå±æ€§çš„å€¼ä¾èµ–äºåœ¨å…¶ä»–å¯¹è±¡ä¸­çš„å±æ€§ã€‚å¦‚æœä¸€ä¸ªä¾èµ–å±æ€§çš„å€¼æ”¹å˜äº†ï¼Œè¿™ä¸ªå±æ€§ä¹Ÿéœ€è¦è¢«é€šçŸ¥åˆ°ã€‚

##### ä¸€å¯¹ä¸€å…³ç³»

```
@interface Person : NSObject
@property (nonatomic, strong, nullable) NSString *firstName;
@property (nonatomic, strong, nullable) NSString *lastName;
@property (nonatomic, strong, readonly) NSString *fullName;
@end
å¤åˆ¶ä»£ç 
```

å¯ä»¥é‡å†™ **keyPathsForValuesAffectingValueForKey:** æ–¹æ³•ã€‚ä¹Ÿå¯ä»¥é€šè¿‡å®ç° **keyPathsForValuesAffecting<Key>** æ–¹æ³•æ¥è¾¾åˆ°å‰é¢åŒæ ·çš„æ•ˆæœï¼Œè¿™é‡Œçš„ **<Key>** å°±æ˜¯å±æ€§åï¼Œä¸è¿‡ç¬¬ä¸€ä¸ªå­—æ¯è¦å¤§å†™ã€‚

```
@implementation Person
- (NSString *)fullName {
    return [NSString stringWithFormat:@"%@ %@", self.firstName, self.lastName];
}

+ (NSSet *)keyPathsForValuesAffectingValueForKey:(NSString *)key {
    NSSet *keyPaths = [super keyPathsForValuesAffectingValueForKey:key];
    if ([key isEqualToString:@"fullName"]) {
        NSArray *affectingKeys = @[@"lastName", @"firstName"];
        keyPaths = [keyPaths setByAddingObjectsFromArray:affectingKeys];
    }
    return keyPaths;
}
// æˆ–è€…
+ (NSSet *)keyPathsForValuesAffectingFullName {
    return [NSSet setWithObjects:@"lastName", @"firstName", nil];
}
@end
å¤åˆ¶ä»£ç 
```

##### ä¸€å¯¹å¤šå…³ç³»

**keyPathsForValuesAffectingValueForKey:** æ–¹æ³•ä¸èƒ½æ”¯æŒä¸€å¯¹å¤šå…³ç³»ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚ä½ æœ‰ä¸€ä¸ª`Department`å¯¹è±¡ï¼Œå’Œå¾ˆå¤šä¸ª`Employee`å¯¹è±¡ã€‚è€Œ`Employee`æœ‰ä¸€ä¸ª`salary`å±æ€§ã€‚ä½ å¯èƒ½å¸Œæœ›`Department`å¯¹è±¡æœ‰ä¸€ä¸ª`totalSalary`çš„å±æ€§ï¼Œä¾èµ–äºæ‰€æœ‰çš„`Employee`çš„`salary` ã€‚

æ³¨å†Œ`Department`æˆä¸ºæ‰€æœ‰`Employee`çš„è§‚å¯Ÿè€…ã€‚å½“`Employee`è¢«æ·»åŠ æˆ–è€…è¢«ç§»é™¤æ—¶è¿›è¡Œè®¡ç®—ã€‚

```
- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary *)change context:(void *)context {
    if (context == totalSalaryContext) {
        [self setTotalSalary:[self valueForKeyPath:@"employees.@sum.salary"]];
    }
    else
    // deal with other observations and/or invoke super...
}
 
- (void)setTotalSalary:(NSNumber *)newTotalSalary {
    if (totalSalary != newTotalSalary) {
        [self willChangeValueForKey:@"totalSalary"];
        _totalSalary = newTotalSalary;
        [self didChangeValueForKey:@"totalSalary"];
    }
}
 
- (NSNumber *)totalSalary {
    return _totalSalary;
}
å¤åˆ¶ä»£ç 
```

### 2.2 å®ç°ç»†èŠ‚

#### 2.2.1 isa-swizzling

KVOçš„å®ç°ç”¨äº†ä¸€ç§å« **isa-swizzling** çš„æŠ€æœ¯ã€‚

å½“ä¸€ä¸ªå¯¹è±¡çš„ä¸€ä¸ªå±æ€§æ³¨å†Œäº†è§‚å¯Ÿè€…åï¼Œè¢«è§‚å¯Ÿå¯¹è±¡çš„`isa`æŒ‡é’ˆçš„å°±æŒ‡å‘äº†ä¸€ä¸ªç³»ç»Ÿä¸ºæˆ‘ä»¬ç”Ÿæˆçš„ä¸­é—´ç±»ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ç±»ã€‚åœ¨è¿™ä¸ªç±»ä¸­ï¼Œç³»ç»Ÿä¸ºæˆ‘ä»¬é‡å†™äº†è¢«è§‚å¯Ÿå±æ€§çš„**setter**æ–¹æ³•ã€‚

é€šè¿‡ **object_getClass(id obj)** æ–¹æ³•å¯ä»¥è·å¾—å®ä¾‹å¯¹è±¡çœŸå®çš„ç±»(`isa`æŒ‡é’ˆçš„æŒ‡å‘)ã€‚

```
@interface Person : NSObject
@property (nonatomic, strong, nullable) NSString *name;
@end
@implementation Person
@end
  
@interface ViewController ()
@property (nonatomic, strong) Person *p1;
@property (nonatomic, strong) Person *p2;
@end

@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];
    self.p1 = [[Person alloc] init];
    self.p2 = [[Person alloc] init];  
    self.p1.name = @"Tom";
    
  	NSLog(@"before kvo --- p2: %s", object_getClassName(self.p2));
    [self.p2 addObserver:self forKeyPath:@"name" options:NSKeyValueObservingOptionNew context:nil];
    NSLog(@"after  kvo --- p2: %s", object_getClassName(self.p2));
    
    self.p2.name = @"Jerry";
}

- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary *)change context:(void *)context {
    if ([keyPath isEqualToString:@"name"]) {
        NSLog(@"new name: %@", change[NSKeyValueChangeNewKey]);
    }
}
@end
// è¾“å‡º
before kvo --- p2: Person
after  kvo --- p2: NSKVONotifying_Person
new name: Jerry
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬åœ¨`p2`å®ä¾‹å¯¹è±¡è¢«é”®å€¼è§‚å¯Ÿçš„å‰åæ‰“å°å…¶`isa`æŒ‡é’ˆ(å®é™…ä½¿ç”¨çš„ç±»)ã€‚

ä»ç»“æœä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`isa`æŒ‡é’ˆæŒ‡å‘äº†ä¸€ä¸ªä¸­é—´ç±»`NSKVONotifying_Person`ã€‚

è‹¹æœçš„KVOä¸­é—´ç±»çš„å‘½åè§„åˆ™æ˜¯åœ¨ç±»åå‰æ·»åŠ `NSKVONotifying_`ï¼Œå¦‚æœæˆ‘ä»¬çš„ç±»å«`Son`KVOä¹‹åçš„ä¸­é—´ç±»ä¸º`NSKVONotifying_Son`ã€‚

#### 2.2.2 IMP

æˆ‘ä»¬å†çœ‹ä¸€ä¸‹KVOå‰åçš„å‡½æ•°æ–¹æ³•çš„åœ°å€æ˜¯å¦ä¸€æ ·ã€‚

```
- (void)viewDidLoad {
    [super viewDidLoad];
    self.p1 = [[Person alloc] init];
    self.p2 = [[Person alloc] init];
    self.p1.name = @"Tom";
    
    NSLog(@"before kvo --- p1: %p p2: %p", [self.p1 methodForSelector:@selector(setName:)], [self.p2 methodForSelector:@selector(setName:)]);
    [self.p2 addObserver:self forKeyPath:@"name" options:NSKeyValueObservingOptionNew context:nil];
    NSLog(@" after  kvo --- p1: %p p2: %p", [self.p1 methodForSelector:@selector(setName:)], [self.p2 methodForSelector:@selector(setName:)]);
    
    self.p2.name = @"Jerry";
}
// è¾“å‡º
before kvo --- p1: 0x10ccee670 p2: 0x10ccee670
after  kvo --- p1: 0x10ccee670 p2: 0x7fff258e454b
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬çœ‹åˆ°ç›‘å¬ä¹‹é—´ä¸¤ä¸ªå®ä¾‹å¯¹è±¡çš„ **setName:** æ–¹æ³•çš„å‡½æ•°åœ°å€ç›¸åŒï¼ŒKVOä¹‹å`p2`å®ä¾‹å¯¹è±¡çš„ **setName:** æ–¹æ³•åœ°å€å˜äº†ã€‚

æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•åœ°å€ï¼š

```
(lldb) image lookup -a 0x7fff258e454b
      Address: Foundation[0x000000000006954b] (Foundation.__TEXT.__text + 422667)
      Summary: Foundation`_NSSetObjectValueAndNotify
å¤åˆ¶ä»£ç 
```

è¿™ä¸ªæ˜¯`Foundation`æ¡†æ¶ä¸­çš„ä¸€ä¸ªç§æœ‰æ–¹æ³• **_NSSetObjectValueAndNotify** ã€‚



![Foundation __NSSetObjectValueAndNotify](https://user-gold-cdn.xitu.io/2020/7/10/173372b8804089b5?imageView2/0/w/1280/h/960/ignore-error/1)



å¯ä»¥çœ‹åˆ° **_NSSetObjectValueAndNotify** è¿˜æ˜¯è°ƒç”¨äº† **willChangeValueForKey:** å’Œ **didChangeValueForKey:** æ¥è¿›è¡Œæ‰‹åŠ¨é€šçŸ¥çš„ã€‚

### 2.3 è‡ªå®šä¹‰KVO

ä¸‹é¢æˆ‘ä»¬æ ¹æ®KVOçš„å®ç°ç»†èŠ‚ï¼Œä»¿å†™ä¸€ä¸ª **éå¸¸ç®€åŒ–ç‰ˆ** çš„KVOã€‚

```
NSString *ObserverKey = @"SetterMethodKey";
// æ ¹æ®æ–¹æ³•åè·å–Key
NSString *getKeyForSetter(NSString *setter) {
    NSRange range = NSMakeRange(3, setter.length - 4);
    NSString *key = [setter substringWithRange:range];
    NSString *letter = [[key substringToIndex:1] lowercaseString];
    key = [key stringByReplacingCharactersInRange:NSMakeRange(0, 1) withString:letter];
    return key;
}
// å®ç°ä¸€ä¸ªsetterå’Œé€šçŸ¥å‡½æ•°
void _MySetObjectValueAndNotify(id self, SEL selector, NSString *name) {
    // 1.è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•
    struct objc_super superClass = {
        self,
        class_getSuperclass([self class])
    };
    objc_msgSendSuper(&superClass, selector, name);
    // 2.é€šçŸ¥è§‚å¯Ÿè€…
    NSObject *observer = objc_getAssociatedObject(self, &ObserverKey);
    NSString *selectorName = NSStringFromSelector(selector);
    NSString *key = getKeyForSetter(selectorName);
    objc_msgSend(observer, @selector(observeValueForKeyPath:ofObject:change:context:), key, self, @{NSKeyValueChangeNewKey: name}, nil);
}

@implementation Person
- (void)snx_addObserver:(NSObject *)observer forKeyPath:(NSString *)keyPath options:(NSKeyValueObservingOptions)options context:(void *)context {
    // 1.åˆ›å»ºä¸€ä¸ªå­ç±»
    NSString *oldName = NSStringFromClass([self class]);
    NSString *newName = [NSString stringWithFormat:@"CustomKVO_%@", oldName];
    Class customClass = objc_allocateClassPair([self class], newName.UTF8String, 0);
    objc_registerClassPair(customClass);
    // 2.ä¿®æ”¹ä¿®æ”¹isaæŒ‡é’ˆ
    object_setClass(self, customClass);
    // 3.é‡å†™setæ–¹æ³•
    NSString *selectorName = [NSString stringWithFormat:@"set%@:", keyPath.capitalizedString];
    SEL sel = NSSelectorFromString(selectorName);
    class_addMethod(customClass, sel, (IMP)_MySetObjectValueAndNotify, "v@:@");
    // 4.ç»‘å®šè§‚å¯Ÿè€…
    objc_setAssociatedObject(self, &ObserverKey, observer, OBJC_ASSOCIATION_ASSIGN);
}
@end
å¤åˆ¶ä»£ç 
```

> **é‡è¦**
>
> ä½¿ç”¨**objc_msgSendSuper**æ—¶ï¼Œå¯èƒ½ç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼š
>
> **Too many arguments to function call, expected 0, have 3**
>
> è§£å†³åŠæ³•ï¼šåœ¨**Build Setting**ä¿®æ”¹**Enable Strict Checking of objc_msgSend Calls**ä¸º**No**ã€‚

```
- (void)viewDidLoad {
    [super viewDidLoad];
    self.p1 = [[Person alloc] init];
    self.p2 = [[Person alloc] init];
    self.p1.name = @"Tom";
    
    NSLog(@"before kvo --- p2: %s", object_getClassName(self.p2));
    NSLog(@"before kvo --- p1: %p p2: %p", [self.p1 methodForSelector:@selector(setName:)], [self.p2 methodForSelector:@selector(setName:)]);
//    [self.p2 addObserver:self forKeyPath:@"name" options:NSKeyValueObservingOptionNew context:nil];
    [self.p2 snx_addObserver:self forKeyPath:@"name" options:NSKeyValueObservingOptionNew context:nil];
    NSLog(@"after  kvo --- p2: %s", object_getClassName(self.p2));
    NSLog(@"after  kvo --- p1: %p p2: %p", [self.p1 methodForSelector:@selector(setName:)], [self.p2 methodForSelector:@selector(setName:)]);
    
    self.p2.name = @"Jerry";
}
// è¾“å‡º
before kvo --- p2: Person
before kvo --- p1: 0x103514460 p2: 0x103514460
after  kvo --- p2: CustomKVO_Person
after  kvo --- p1: 0x103514460 p2: 0x103513f90
new name: Jerry
```